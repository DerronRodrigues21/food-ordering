<?php include 'config.php'; if (!isset($_SESSION['customer_id'])) die('login required'); if ($_SERVER['REQUEST_METHOD'] !== 'POST') die('invalid'); $customer_id = $_SESSION['customer_id']; $address = $conn->real_escape_string($_POST['address']); $method = isset($_POST['method'])?$_POST['method']:'CASH'; $cart = isset($_SESSION['cart'])?$_SESSION['cart']:[]; if (empty($cart)) die('cart empty'); $conn->begin_transaction(); try { $ids = implode(',', array_keys($cart)); $res = $conn->query("SELECT restaurant_id FROM Menu_Item WHERE item_id IN ($ids) LIMIT 1"); $r = $res->fetch_assoc(); $restaurant_id = $r['restaurant_id']; $stmt = $conn->prepare("INSERT INTO `Order` (customer_id,restaurant_id,delivery_address,status) VALUES (?,?,?, 'PLACED')"); $stmt->bind_param("iis", $customer_id, $restaurant_id, $address); $stmt->execute(); $order_id = $conn->insert_id; $stmtI = $conn->prepare("INSERT INTO Order_Item (order_id,item_id,quantity,item_price) VALUES (?,?,?,?)"); foreach($cart as $item_id => $qty){ $r2 = $conn->query("SELECT price FROM Menu_Item WHERE item_id=".intval($item_id)); $row = $r2->fetch_assoc(); $price = $row['price']; $stmtI->bind_param('iiid', $order_id, $item_id, $qty, $price); $stmtI->execute(); } $resT = $conn->query("SELECT SUM(quantity*item_price) AS total FROM Order_Item WHERE order_id=$order_id"); $tot = $resT->fetch_assoc()['total']; $conn->query("UPDATE `Order` SET total_amount=$tot WHERE order_id=$order_id"); $stmtP = $conn->prepare("INSERT INTO Payment (order_id,amount,status,method) VALUES (?,?, 'PENDING',?)"); $stmtP->bind_param('ids', $order_id, $tot, $method); $stmtP->execute(); $conn->commit(); unset($_SESSION['cart']); unset($_SESSION['cart_restaurant']); $order_info = $conn->query("SELECT o.order_id,o.order_date,o.total_amount,o.delivery_address,p.method FROM `Order` o JOIN Payment p ON p.order_id=o.order_id WHERE o.order_id=$order_id")->fetch_assoc(); $items = $conn->query("SELECT mi.name, oi.quantity, oi.item_price FROM Order_Item oi JOIN Menu_Item mi ON oi.item_id=mi.item_id WHERE oi.order_id=$order_id"); ?> <!doctype html><html><head><meta charset='utf-8'><title>Order Confirmed</title><link rel='stylesheet' href='style.css'></head><body><div class='container'><div class='card' style='max-width:720px;margin:40px auto;text-align:center'><h2>Order Confirmed</h2><div class='small'>Transaction time: <?php echo $order_info['order_date']; ?></div><h3>Order #<?php echo $order_info['order_id']; ?></h3><div style='text-align:left;margin-top:14px'><h4>Items</h4><ul><?php while($it=$items->fetch_assoc()){ echo '<li>'.$it['name'].' x'.$it['quantity'].' â€¢ Rs '.$it['item_price'].'</li>'; } ?></ul><p><strong>Total:</strong> Rs <?php echo $order_info['total_amount']; ?></p><p><strong>Delivery address:</strong><br><?php echo nl2br(htmlspecialchars($order_info['delivery_address'])); ?></p><p><strong>Payment method:</strong> <?php echo htmlspecialchars($order_info['method']); ?></p><div style='margin-top:16px'><a class='btn' href='your_orders.php'>View your orders</a> <a class='btn secondary' href='index.php'>Home</a></div></div></div></div></body></html><?php exit; } catch(Exception $e){ $conn->rollback(); echo 'Error: '.$conn->error; } ?>